<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Заметки</title>
</head>
<style>
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1e1e2f, #3a3a5a);
            margin: 0;
            padding: 20px;
            color: #eaeaea;
        }

       .container {
        max-width: 800px;
        margin: auto;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.2);
        transition: box-shadow 0.3s ease;
    }

    .container:hover {
        box-shadow: 0 8px 50px rgba(0, 0, 0, 0.3);
    }

    h1, h2 {
        text-align: center;
        color: #00bcd4;
        text-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
    }

    textarea, input {
    width: 100%;
    max-width: 100%;
    margin-bottom: 10px;
    border: none;
    border-radius: 8px;
    padding: 15px;
    font-size: 16px;
    background: rgba(255, 255, 255, 0.2);
    color: #eaeaea;
    transition: background-color 0.3s ease;
    box-sizing: border-box; /* ⬅️ Ключевое исправление */
    }

    textarea:focus, input:focus {
    background: rgba(255, 255, 255, 0.3);
    outline: none;
    box-sizing: border-box; /* На всякий случай */
    }



    button {
        width: 100%;
        padding: 15px;
        background: linear-gradient(90deg, #00bcd4, #3f51b5);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background 0.3s ease, transform 0.2s ease;
        box-shadow: 0 4px 15px rgba(0, 188, 212, 0.3);
    }

    button:hover {
        background: linear-gradient(90deg, #3f51b5, #00bcd4);
        transform: translateY(-2px);
    }

    .note {
        background: rgba(255, 255, 255, 0.15);
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.2);
    }

    .tag-group {
        margin-top: 20px;
        border-radius: 8px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    }

    .tag-group h3 {
        margin: 0;
        color: #00bcd4;
        text-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
    }

    svg {
        border: 1px solid #ccc;
        margin-top: 20px;
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(90deg, #4CAF50, #45a049);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        z-index: 1000;
        transform: translateX(150%);
        transition: transform 0.3s ease-in-out;
        font-weight: bold;
    }

    .notification.show {
        transform: translateX(0);
    }

    .notification.hide {
        transform: translateX(150%);
    }
</style>
<body>
    <div class="container">

        <div style="text-align: right; margin-bottom: 20px;">
            <a href="/logout" style="background: #f44336; color: white; padding: 10px 15px;
            text-decoration: none; border-radius: 5px; display: inline-block;">
                Выйти (куда эту кнопку засунуть)
            </a>
        </div>

        <h1>Мои Заметки</h1>
        <input type="text" id="noteTitle" placeholder="Заголовок заметки..." />
        <textarea id="noteInput" placeholder="Введите вашу заметку..."></textarea>
        <input type="text" id="tagsInput" placeholder="Введите теги (через запятую)" />
        <button id="addNoteButton">Добавить Заметку</button>

        <div style="height: 30px;"></div>
        <div style="text-align: center; margin-bottom: 20px;">
            <a href="/all-notes" style="background: #6c757d; color: white; padding: 10px 20px;
                text-decoration: none; border-radius: 5px; display: inline-block;">
                Посмотреть все заметки
            </a>
        </div>

        <h2>Граф заметок</h2>
        <div id="graph-container" style="width: 100%; height: 500px; background: rgba(0,0,0,0.1); border-radius: 12px; margin-top: 15px;"></div>
        <div id="graph-status" style="text-align: center; margin-top: 10px; color: #a0a0c0; font-size: 0.9em;">Загрузка графа заметок...</div>
    </div>


    <div id="notification" class="notification">
        Заметка сохранена!
    </div>

    <script src="https://unpkg.com/force-graph"></script>
<script>

    document.addEventListener('DOMContentLoaded', function() {
        loadNotesGraph();
    });

    document.getElementById('addNoteButton').addEventListener('click', function() {
        const noteTitle = document.getElementById('noteTitle').value.trim();
        const noteContent = document.getElementById('noteInput').value.trim();
        const tagsText = document.getElementById('tagsInput').value.trim();

        if (!noteTitle || !noteContent) {
            alert('Пожалуйста, заполните заголовок и содержание заметки!');
            return;
        }

        createNote(noteTitle, noteContent, tagsText);
    });

    async function createNote(title, content, tags) {
        try {
            const response = await fetch('/api/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: title,
                    content: content,
                    tags: tags.split(',').map(t => t.trim())
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Ошибка создания заметки');
            }

            document.getElementById('noteTitle').value = '';
            document.getElementById('noteInput').value = '';
            document.getElementById('tagsInput').value = '';

            loadNotesGraph();
            showNotification();
        } catch (error) {
            console.error('Error:', error);
            alert('Ошибка при создании заметки: ' + error.message);
        }
    }

    async function loadNotesGraph() {
        try {
            document.getElementById('graph-status').textContent = 'Загрузка данных...';
            const response = await fetch('/api/graph-data');
            if (!response.ok) throw new Error('Не удалось загрузить граф');
            const data = await response.json();

            renderNotesGraph(data);
            document.getElementById('graph-status').textContent =
                `Заметок: ${data.nodes.length}, связей: ${data.links.length}`;
        } catch (error) {
            console.error('Graph error:', error);
            document.getElementById('graph-status').textContent = 'Ошибка загрузки графа';
        }
    }

    function renderNotesGraph(data) {
    const container = document.getElementById('graph-container');
    container.innerHTML = '';

    if (data.nodes.length === 0) {
        container.innerHTML = '<div style="height:100%;display:flex;align-items:center;justify-content:center;color:#a0a0c0;">Нет заметок</div>';
        return;
    }

    function generateTagColor(tag) {
        let hash = 0;
        for (let i = 0; i < tag.length; i++) {
            hash = tag.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = 180 + Math.abs(hash) % 40; // 180–220
        const saturation = 70 + (hash % 20);   // 70–90%
        const lightness = 55 + (hash % 15);    // 55–70%
        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    const tagColors = {};
    data.links.forEach(link => {
        const tag = link.via_tag;
        if (tag && !tagColors[tag]) {
            tagColors[tag] = generateTagColor(tag);
        }
    });

    const img = new Image();
    img.src = '/static/5276326984803189260.png';
    img.crossOrigin = "anonymous";

    img.onload = () => {
        const width = container.clientWidth;
        const height = container.clientHeight;

        const Graph = ForceGraph()(container)
            .graphData(data)
            .nodeId("id")
            .nodeLabel(node => `${node.title}\nТеги: ${node.tags.join(', ')}`)
            .nodeCanvasObject((node, ctx, globalScale) => {
                const size = 15;
                ctx.drawImage(img, node.x - size / 2, node.y - size / 2, size, size);
            })
            .linkWidth(2)
            .linkColor(link => tagColors[link.via_tag] || '#00bcd4')
            .backgroundColor('transparent')
            .onNodeClick(node => {
                window.location.href = `/note/${node.id}`;
            })
            .d3Force('link', ForceGraph.d3Force('link').distance(130))
            .d3Force('charge', ForceGraph.d3Force('charge').strength(-800))
            .d3Force('center', ForceGraph.d3Force('center').x(width / 2).y(height / 2))
            .d3Force('collide', ForceGraph.d3Force('collide').radius(50))
            .width(width)
            .height(height);

        // Зафиксировать узлы после их первой отрисовки
        Graph.onEngineStop(() => {
            data.nodes.forEach(node => {
                node.fx = node.x; // Фиксируем положение по X
                node.fy = node.y; // Фиксируем положение по Y
            });
            Graph.d3Force('charge').strength(0); // Отключаем силу отталкивания
            Graph.d3Force('center').strength(0); // Отключаем силу центрирования
        });
    };

    img.onerror = () => {
        console.error('Изображение не загружено. Используем резервный кружок.');
        const width = container.clientWidth;
        const height = container.clientHeight;

        const Graph = ForceGraph()(container)
            .graphData(data)
            .nodeId("id")
            .nodeCanvasObject((node, ctx) => {
                ctx.beginPath();
                ctx.arc(node.x, node.y, 16, 0, 2 * Math.PI);
                ctx.fillStyle = '#00bcd4';
                ctx.fill();
            })
            .linkColor(link => tagColors[link.via_tag] || '#00bcd4')
            .d3Force('link', ForceGraph.d3Force('link').distance(130))
            .d3Force('charge', ForceGraph.d3Force('charge').strength(-800))
            .d3Force('center', ForceGraph.d3Force('center').x(width / 2).y(height / 2))
            .d3Force('collide', ForceGraph.d3Force('collide').radius(50))
            .width(width)
            .height(height);

        // Зафиксировать узлы после их первой отрисовки
        Graph.onEngineStop(() => {
            data.nodes.forEach(node => {
                node.fx = node.x; // Фиксируем положение по X
                node.fy = node.y; // Фиксируем положение по Y
            });
            Graph.d3Force('charge').strength(0); // Отключаем силу отталкивания
            Graph.d3Force('center').strength(0); // Отключаем силу центрирования
        });
    };
}


    function showNotification() {
        const notification = document.getElementById('notification');
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
        }, 2500);
    }
</script>
    <div id="notification" class="notification">
         Заметка сохранена!
    </div>

</body>
</html>